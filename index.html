<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="no-referrer">
    <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=()">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Lemonade">
    <link rel="icon" href="icon.svg">
    <link rel="apple-touch-icon" href="icon.svg">
    <link rel="manifest" href="manifest.json">
    <title>Lemonade</title>
    <style>
        /* CSS with dark/light mode support */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --title-gradient: linear-gradient(90deg, #000000, #000000);
            --card-bg: #ffffff;
            --accent-color: #000000;
            --border-color: #dddddd;
            --input-bg: #ffffff;
            --button-bg: #000000;
            --button-text: #ffffff;
            --button-hover: #333333;
            --success-color: #00cc66;
            --error-color: #cc3300;
            --warning-color: #f0ad4e;
            --cyber-line: rgba(0, 0, 0, 0.15);
            --cyber-glow: rgba(0, 0, 0, 0.4);
            --security-high: #00cc66;
            --security-medium: #f0ad4e;
            --security-low: #cc3300;
        }

        /* Dark mode class */
        body.dark-mode {
            --bg-color: #000000;
            --text-color: #ffffff;
            --title-gradient: linear-gradient(90deg, #FF00FF, #00FFFF, #FFFF00);
            --card-bg: rgba(18, 18, 18, 0.7);
            --accent-color: #FF00FF; /* Neon Pink */
            --border-color: #333333;
            --input-bg: rgba(26, 26, 26, 0.7);
            --button-bg: #00FFFF; /* Neon Teal */
            --button-text: #000000;
            --button-hover: #FF00FF; /* Neon Purple */
            --success-color: #39FF14; /* Neon Green */
            --error-color: #FF3131; /* Neon Red */
            --warning-color: #FFFF00; /* Neon Yellow */
            --cyber-line: rgba(0, 255, 255, 0.4); /* Brighter Neon Teal */
            --cyber-glow: rgba(255, 0, 255, 0.6); /* Brighter Neon Purple */
            --security-high: #39FF14; /* Neon Green */
            --security-medium: #FFFF00; /* Neon Yellow */
            --security-low: #FF3131; /* Neon Red */
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            display: none;
        }

        /* Psychedelic Background */
        body.dark-mode::before {
            content: "";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(
                125deg,
                #000000,
                #220033,
                #000033,
                #330033,
                #000022
            );
            background-size: 400% 400%;
            animation: gradient-shift 15s ease infinite;
            opacity: 0.9;
        }

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Add scanlines overlay */
        body.dark-mode::after {
            content: "";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
        }

        /* Enhanced App Title */
        body.dark-mode .app-title {
            background: var(--title-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 15px var(--cyber-glow);
            animation: title-shift 5s ease infinite;
        }

        @keyframes title-shift {
            0% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(90deg); }
            100% { filter: hue-rotate(0deg); }
        }

        /* Enhanced Cards with Glowing Borders */
        body.dark-mode .card {
            border: 1px solid var(--accent-color);
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.5);
            backdrop-filter: blur(5px);
            animation: border-pulse 4s infinite;
        }

        @keyframes border-pulse {
            0% { border-color: #FF00FF; box-shadow: 0 0 15px rgba(255, 0, 255, 0.5); }
            33% { border-color: #00FFFF; box-shadow: 0 0 15px rgba(0, 255, 255, 0.5); }
            66% { border-color: #FFFF00; box-shadow: 0 0 15px rgba(255, 255, 0, 0.5); }
            100% { border-color: #FF00FF; box-shadow: 0 0 15px rgba(255, 0, 255, 0.5); }
        }

        /* Enhanced Buttons with Glow Effect */
        body.dark-mode button {
            border: 1px solid transparent;
            box-shadow: 0 0 10px var(--cyber-glow);
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        body.dark-mode button:hover {
            box-shadow: 0 0 20px var(--cyber-glow);
            transform: translateY(-2px);
        }

        /* Psychedelic button effects */
        body.dark-mode button::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                #FF00FF,
                #00FFFF,
                #FFFF00,
                #FF00FF
            );
            animation: rotate 3s linear infinite;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: -1;
        }

        body.dark-mode button:hover::before {
            opacity: 0.3;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Enhanced Input Fields */
        body.dark-mode input, 
        body.dark-mode textarea, 
        body.dark-mode select {
            border: 1px solid var(--border-color);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        body.dark-mode input:focus, 
        body.dark-mode textarea:focus, 
        body.dark-mode select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 15px var(--cyber-glow), inset 0 0 10px rgba(0, 0, 0, 0.5);
            animation: focus-pulse 2s infinite;
        }

        @keyframes focus-pulse {
            0% { border-color: #FF00FF; }
            50% { border-color: #00FFFF; }
            100% { border-color: #FF00FF; }
        }

        /* Enhanced Security Badges */
        body.dark-mode .security-badge {
            animation: security-pulse 2s infinite;
            text-shadow: 0 0 5px currentColor;
        }

        @keyframes security-pulse {
            0% { box-shadow: 0 0 5px currentColor; }
            50% { box-shadow: 0 0 15px currentColor; }
            100% { box-shadow: 0 0 5px currentColor; }
        }

        /* Enhanced Key Items */
        body.dark-mode .key-item {
            border: 1px solid var(--border-color);
            background: linear-gradient(145deg, rgba(18, 18, 18, 0.7), rgba(26, 26, 26, 0.7));
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        body.dark-mode .key-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.3);
        }

        /* Tab Button Enhancement */
        body.dark-mode .tab-btn.active {
            background: linear-gradient(90deg, rgba(0, 0, 0, 0.5), rgba(255, 0, 255, 0.1), rgba(0, 0, 0, 0.5));
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.3);
            animation: tab-shift 3s infinite;
        }

        @keyframes tab-shift {
            0% { border-color: #FF00FF; }
            33% { border-color: #00FFFF; }
            66% { border-color: #FFFF00; }
            100% { border-color: #FF00FF; }
        }

        /* Switch slider enhancement */
        body.dark-mode .slider {
            background: linear-gradient(90deg, #220033, #000033);
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }

        body.dark-mode input:checked + .slider {
            background: linear-gradient(90deg, #00FFFF, #FF00FF);
        }

        body.dark-mode .slider:before {
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        /* Status enhancement */
        body.dark-mode .status.success,
        body.dark-mode .status.warning,
        body.dark-mode .status.error {
            animation: status-pulse 2s infinite;
        }

        @keyframes status-pulse {
            0% { box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3); }
            50% { box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5); }
            100% { box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3); }
        }

        /* Loading animation enhancement */
        body.dark-mode .spinner {
            border: 5px solid rgba(0, 0, 0, 0.3);
            border-top-color: var(--accent-color);
            animation: spin 1s ease-in-out infinite, color-shift 3s linear infinite;
        }

        @keyframes color-shift {
            0% { border-top-color: #FF00FF; }
            33% { border-top-color: #00FFFF; }
            66% { border-top-color: #FFFF00; }
            100% { border-top-color: #FF00FF; }
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .app-header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .app-title {
            font-size: 1.8rem;
            margin: 0;
            background: var(--title-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 15px var(--cyber-glow);
        }

        .app-subtitle {
            font-size: 0.9rem;
            margin: 0;
            padding-top: 2px;
            font-style: italic;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .app-header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #33aaff, #0066cc);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab-btn {
            background: none;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            color: var(--text-color);
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .tab-btn.active {
            border-bottom: 2px solid var(--accent-color);
            color: var(--accent-color);
        }
        
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: var(--accent-color);
            transition: width 0.3s;
        }
        
        .tab-btn:hover::after {
            width: 100%;
        }
        
        .tab-content {
            display: none !important;
        }
        
        .tab-content.active {
            display: block !important;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--cyber-glow);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        button {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            position: relative;
            overflow: hidden;
        }
        
        button:hover {
            background-color: var(--button-hover);
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        button:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% { transform: scale(0, 0); opacity: 0.5; }
            100% { transform: scale(20, 20); opacity: 0; }
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
        }
        
        .btn-secondary:hover {
            background-color: rgba(51, 170, 255, 0.1);
        }
        
        .status {
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        
        .status.success {
            background-color: rgba(0, 204, 102, 0.1);
            color: var(--success-color);
            border: 1px solid var(--success-color);
            display: block;
        }
        
        .status.warning {
            background-color: rgba(240, 173, 78, 0.1);
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
            display: block;
        }
        
        .status.error {
            background-color: rgba(204, 51, 0, 0.1);
            color: var(--error-color);
            border: 1px solid var(--error-color);
            display: block;
        }
        
        .key-item {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        
        .key-item h3 {
            margin-top: 0;
            margin-bottom: 10px;
        }

        .key-header {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .key-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }
        
        .key-meta {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 5px;
        }

        .btn-zero {
            background-color: #cc3300;
            color: white;
            margin-top: 20px;
            width: 100%;
            font-weight: bold;
            border: 1px solid #aa2200;
        }

        .btn-zero:hover {
            background-color: #ff3300;
        }

        /* Dark mode override to ensure it stays red */
        body.dark-mode .btn-zero {
            background-color: #ff3131; /* Neon Red */
            color: white;
            border: 1px solid #cc0000;
        }

        body.dark-mode .btn-zero:hover {
            background-color: #ff5555; /* Lighter Neon Red */
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .password-strength {
            height: 5px;
            border-radius: 5px;
            margin-top: 5px;
            transition: all 0.3s;
        }
        
        .password-strength.weak {
            background-color: var(--security-low);
            width: 30%;
        }
        
        .password-strength.medium {
            background-color: var(--security-medium);
            width: 60%;
        }
        
        .password-strength.strong {
            background-color: var(--security-high);
            width: 100%;
        }
        
        .password-feedback {
            font-size: 0.8rem;
            margin-top: 5px;
        }
        
        .security-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 8px;
            font-weight: bold;
        }
        
        .security-badge.high {
            background-color: rgba(0, 204, 102, 0.1);
            color: var(--security-high);
            border: 1px solid var(--security-high);
        }
        
        .security-badge.medium {
            background-color: rgba(240, 173, 78, 0.1);
            color: var(--security-medium);
            border: 1px solid var(--security-medium);
        }
        
        .security-badge.low {
            background-color: rgba(204, 51, 0, 0.1);
            color: var(--security-low);
            border: 1px solid var(--security-low);
        }

        /* Security badge pulse animation */
        @keyframes securityPulse {
            0% {
                box-shadow: 0 0 5px currentColor;
            }
            50% {
                box-shadow: 0 0 15px currentColor;
            }
            100% {
                box-shadow: 0 0 5px currentColor;
            }
        }

        /* Add pulsing effect to security badges in dark mode */
        body.dark-mode .security-badge {
            animation: securityPulse 2s infinite;
            transition: all 0.3s ease;
        }

        /* Enhanced colors for dark mode security badges */
        body.dark-mode .security-badge.high {
            box-shadow: 0 0 5px var(--security-high);
        }

        body.dark-mode .security-badge.medium {
            box-shadow: 0 0 5px var(--security-medium);
        }

        body.dark-mode .security-badge.low {
            box-shadow: 0 0 5px var(--security-low);
        }

        .key-pair-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 5px;
        }

        .key-pair-badge.full {
            background-color: rgba(0, 204, 102, 0.1);
            color: var(--security-high);
            border: 1px solid var(--security-high);
        }

        .key-pair-badge.private {
            background-color: rgba(204, 51, 0, 0.1);
            color: var(--security-low);
            border: 1px solid var(--security-low);
        }

        .key-pair-badge.public {
            background-color: rgba(240, 173, 78, 0.1);
            color: var(--security-medium);
            border: 1px solid var(--security-medium);
        }

        .private-key-btn {
            border: 1px solid var(--error-color) !important;
            color: var(--error-color) !important;
        }

        .private-key-btn:hover {
            background-color: rgba(204, 51, 0, 0.1) !important;
        }

        /* Enhanced colors for dark mode key pair badges */
        body.dark-mode .key-pair-badge.full {
            box-shadow: 0 0 5px var(--security-high);
        }

        body.dark-mode .key-pair-badge.private {
            box-shadow: 0 0 5px var(--security-low);
        }

        body.dark-mode .key-pair-badge.public {
            box-shadow: 0 0 5px var(--security-medium);
        }

        body.dark-mode .private-key-btn {
            border: 1px solid var(--error-color) !important;
            color: var(--error-color) !important;
        }

        body.dark-mode .private-key-btn:hover {
            background-color: rgba(255, 49, 49, 0.2) !important;
        }
        
        .config-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .config-toggle label {
            display: inline;
            margin-bottom: 0;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--accent-color);
        }
        
        input:focus + .slider {
            box-shadow: 0 0 1px var(--accent-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .security-info {
            font-size: 0.9rem;
            padding: 10px;
            border-left: 3px solid var(--accent-color);
            background-color: rgba(51, 170, 255, 0.05);
            margin-bottom: 15px;
        }
        
        .key-expiry {
            font-size: 0.8rem;
            color: var(--warning-color);
            margin-top: 5px;
            font-style: italic;
        }
        
        #inactivityModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            max-width: 400px;
            text-align: center;
        }
        
        .timer {
            font-size: 2rem;
            margin: 20px 0;
            color: var(--warning-color);
        }
        
        /* Additional settings section */
        #settings {
            display: none;
        }
        
        .settings-section {
            margin-bottom: 20px;
        }
        
        .settings-section h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            .card {
                padding: 15px;
            }
            
            .app-title {
                font-size: 1.5rem;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .tab-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }

    .file-info {
        margin-top: 10px;
        font-size: 0.9rem;
        background-color: var(--input-bg);
        padding: 8px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .file-info-name {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .file-icon {
        margin-right: 8px;
        font-size: 1.2rem;
    }

    .remove-file {
        cursor: pointer;
        color: var(--error-color);
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 8px;
    }

    .remove-file:hover {
        background-color: rgba(204, 51, 0, 0.1);
    }

    /* Password Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1001;
        justify-content: center;
        align-items: center;
    }
    
    .modal-content {
        background-color: var(--card-bg);
        padding: 20px;
        border-radius: 12px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        position: relative;
    }
    
    body.dark-mode .modal-content {
        border: 1px solid var(--accent-color);
        box-shadow: 0 0 15px rgba(255, 0, 255, 0.5);
    }
    
    .btn-primary {
        background-color: var(--accent-color);
        color: var(--button-text);
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.1s;
    }
    
    .btn-primary:hover {
        background-color: var(--button-hover);
    }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header">
            <h1 class="app-title">Lemonade</h1>
            <div class="app-subtitle">by elkmire</div>
            <p>The offline security method</p>
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" data-tab="encrypt">Encrypt</button>
            <button class="tab-btn" data-tab="decrypt">Decrypt</button>
            <button class="tab-btn" data-tab="keys">Key Management</button>
            <button class="tab-btn" data-tab="settings">Settings</button>
        </div>
        
        <div class="tab-content active" id="encrypt">
            <div class="card">
                <div class="form-group">
                    <label for="encryptMessage">To Encrypt</label>
                    <textarea id="encryptMessage" placeholder="Free-type here or load file for encryption..."></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <button id="encryptBrowseBtn" class="btn-secondary">Browse Files</button>
                        <button id="clearEncryptMessageBtn" class="btn-secondary">Clear</button>
                        <input type="file" id="encryptFileInput" style="display: none;">
                    </div>
                    <div id="encryptFileInfo" style="display: none;" class="file-info">
                        <span><span class="file-icon">📄</span> <span id="encryptFileName" class="file-info-name"></span></span>
                        <span class="remove-file" id="removeEncryptFile">×</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="encryptionKey">Encryption Key</label>
                    <select id="encryptionKey">
                        <option value="">Select a key...</option>
                    </select>
                </div>
                
                <div class="form-group" id="encryptionPasswordGroup" style="display: none;">
                    <label for="encryptionPassword">Key Password</label>
                    <input type="password" id="encryptionPassword" placeholder="Enter key password">
                </div>
                
                <button id="encryptBtn">Encrypt Data</button>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="encryptedOutput">Encrypted Data</label>
                    <textarea id="encryptedOutput" readonly></textarea>
                </div>
                
                <div class="btn-group">
                    <button id="downloadEncryptedBtn" class="btn-secondary">Download Encrypted File</button>
                    <button id="copyEncryptedBtn" class="btn-secondary">Copy to Clipboard</button>
                    <button id="clearEncryptBtn" class="btn-secondary">Clear All</button>
                </div>
                
                <div id="encryptStatus" class="status"></div>
            </div>
        </div>
        
        <div class="tab-content" id="decrypt">
            <div class="card">
                <div class="form-group">
                    <label for="encryptedMessage">To Decrypt</label>
                    <textarea id="encryptedMessage" placeholder="Paste the encrypted data here or load encrypted data..."></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <button id="decryptBrowseBtn" class="btn-secondary">Browse Files</button>
                        <button id="clearEncryptedMessageBtn" class="btn-secondary">Clear</button>
                        <input type="file" id="decryptFileInput" style="display: none;">
                    </div>
                    <div id="decryptFileInfo" style="display: none;" class="file-info">
                        <span><span class="file-icon">📄</span> <span id="decryptFileName" class="file-info-name"></span></span>
                        <span class="remove-file" id="removeDecryptFile">×</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="decryptionKey">Decryption Key</label>
                    <select id="decryptionKey">
                        <option value="">Select a key...</option>
                    </select>
                </div>
                
                <div class="form-group" id="decryptionPasswordGroup" style="display: none;">
                    <label for="decryptionPassword">Key Password</label>
                    <input type="password" id="decryptionPassword" placeholder="Enter key password">
                </div>
                
                <button id="decryptBtn">Decrypt Data</button>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="decryptedOutput">Decrypted Data</label>
                    <textarea id="decryptedOutput" readonly></textarea>
                </div>
                
                <div class="btn-group">
                    <button id="downloadDecryptedBtn" class="btn-secondary">Download Decrypted File</button>
                    <button id="copyDecryptedBtn" class="btn-secondary">Copy to Clipboard</button>
                    <button id="clearDecryptBtn" class="btn-secondary">Clear All</button>
                </div>
                
                <div id="decryptStatus" class="status"></div>
            </div>
        </div>
        
        <div class="tab-content" id="keys">
            <div class="card">
                <h2>Key Management</h2>
                
                <div class="security-info">
                    <strong>Security Note:</strong> All keys are stored locally in your browser's protected storage and never sent to any server.
                </div>
                
                <div class="form-group">
                    <label for="keyName">Key Name</label>
                    <input type="text" id="keyName" placeholder="e.g., enter crypto name">
                </div>
                
                <div class="form-group">
                    <label for="keyType">Key Type</label>
                    <select id="keyType">
                        <option value="aes">AES-GCM (Symmetric) - 256 bits</option>
                        <option value="rsa">RSA-OAEP (Asymmetric) - 2048 bits</option>
                        <option value="rsa-4096">RSA-OAEP (Asymmetric) - 4096 bits</option>
                        <option value="ecc">ECC (Asymmetric) - P-256</option>
                        <option value="ecc-p384">ECC (Asymmetric) - P-384</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="keyExpiry">Key Expiration (Optional)</label>
                    <select id="keyExpiry">
                        <option value="">Never (Not Recommended)</option>
                        <option value="30">30 Days</option>
                        <option value="90">90 Days</option>
                        <option value="180">180 Days</option>
                        <option value="365">1 Year</option>
                    </select>
                </div>
                
                <div class="form-group" id="keyPasswordGroup">
                    <label for="keyPassword">Key Password (Recommended)</label>
                    <input type="password" id="keyPassword" placeholder="Enter optional password">
                    <div id="passwordStrength" class="password-strength"></div>
                    <div id="passwordFeedback" class="password-feedback"></div>
                </div>
                
                <div class="form-group" id="confirmKeyPasswordGroup">
                    <label for="confirmKeyPassword">Confirm Password</label>
                    <input type="password" id="confirmKeyPassword" placeholder="Confirm your password">
                </div>
                
                <button id="generateKeyBtn">Generate New Key</button>
                
                <div style="margin-top: 30px;">
                    <h3>Your Keys</h3>
                    <div id="keysList">
                        <!-- Keys will be populated here -->
                    </div>
                </div>
                
                <div class="btn-group">
                    <button id="importKeyBtn" class="btn-secondary">Import Key</button>
                    <button id="exportAllKeysBtn" class="btn-secondary">Export State</button>
                    <button id="importStateBtn" class="btn-secondary">Import State</button>
                </div>

                <div style="text-align: center;">
                    <button id="zeroKeysBtn" class="btn-zero">ZERO ALL KEYS</button>
                </div>
                
                <div id="keyStatus" class="status"></div>
            </div>
        </div>
        
        <div class="tab-content" id="settings">
            <div class="card">
                <h2>Security Settings</h2>
<p> (Must SAVE for changes to take effect) <p>
                
                <div class="settings-section">
                    <h3>Storage Options</h3>
                    
                    <div class="config-toggle">
                        <label for="useIndexedDB">Use IndexedDB for key storage (more secure)</label>
                        <label class="switch">
                            <input type="checkbox" id="useIndexedDB" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="config-toggle">
                        <label for="sessionOnly">Session-only mode (keys aren't saved when browser closes)</label>
                        <label class="switch">
                            <input type="checkbox" id="sessionOnly">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Security Parameters</h3>
                    
                    <div class="config-toggle">
                        <label for="enforcePwdProtection">Enforce password protection for keys</label>
                        <label class="switch">
                            <input type="checkbox" id="enforcePwdProtection">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="config-toggle">
                        <label for="enforceKeyExpiry">Enforce key expiration</label>
                        <label class="switch">
                            <input type="checkbox" id="enforceKeyExpiry">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label for="pbkdf2Iterations">PBKDF2 Iterations (higher = more secure but slower)</label>
                        <select id="pbkdf2Iterations">
                            <option value="100000">100,000 (Default)</option>
                            <option value="200000">200,000</option>
                            <option value="300000">300,000</option>
                            <option value="500000">500,000</option>
                        </select>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Appearance</h3>
                    
                    <div class="config-toggle">
                        <label for="darkMode">Dark Mode</label>
                        <label class="switch">
                            <input type="checkbox" id="darkMode">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Install App</h3>
                    <p>Installs PWA (must be Chromium-based browser or Safari for IOS)</p>
                    <div id="installContainer">
                        <button id="installBtn" class="btn-secondary">Install Lemonade App</button>
                        <p class="install-note" style="margin-top: 8px; font-size: 0.85rem; color: #888;">
                            (Button will be enabled when installation is available)
                        </p>
                    </div>
                    <div id="installStatus" class="status"></div>
                </div>

                <div class="btn-group">
                    <button id="saveSettingsBtn">Save Settings</button>
                    <button id="resetSettingsBtn" class="btn-secondary">Reset to Defaults</button>
                </div>
                
                <div id="settingsStatus" class="status"></div>
            </div>
        </div>
    </div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    
    <script>
const PBKDF2_CONFIG={ITERATIONS:1e5,HASH:"SHA-256"},AES_CONFIG={KEY_LENGTH:256,MODE:"AES-GCM",IV_LENGTH:12,TAG_LENGTH:128},RSA_CONFIG={KEY_SIZE:2048,KEY_SIZE_4096:4096,ALGORITHM:"RSA-OAEP",HASH:"SHA-256"},ECC_CONFIG={CURVE:"P-256",CURVE_P384:"P-384",ALGORITHM:"ECDH",KEY_DERIVATION:"HKDF",KDF_HASH:"SHA-256",ENC_ALGORITHM:"AES-GCM"},DB_NAME="LemonadeSecureDB",DB_VERSION=1,KEYS_STORE="keys",SETTINGS_STORE="settings",DEFAULT_SETTINGS={useIndexedDB:!0,sessionOnly:!1,enforcePwdProtection:!1,enforceKeyExpiry:!1,pbkdf2Iterations:1e5};let db=null,keys=[],appSettings={...DEFAULT_SETTINGS};const tabBtns=document.querySelectorAll(".tab-btn"),tabContents=document.querySelectorAll(".tab-content"),encryptionKeySelect=document.getElementById("encryptionKey"),decryptionKeySelect=document.getElementById("decryptionKey"),keysList=document.getElementById("keysList"),loadingOverlay=document.getElementById("loadingOverlay"),inactivityModal=document.getElementById("inactivityModal"),timeoutTimer=document.getElementById("timeoutTimer"),safeMemory={sensitiveData:new WeakMap,store:function(e){const t={id:crypto.randomUUID()};return this.sensitiveData.set(t,e),t},retrieve:function(e,t=!1){if(!this.sensitiveData.has(e))return null;const n=this.sensitiveData.get(e);return t&&this.sensitiveData.delete(e),n},delete:function(e){return!!this.sensitiveData.has(e)&&(this.sensitiveData.delete(e),!0)},clearAll:function(){if(this.sensitiveData=new WeakMap,"function"==typeof window.gc)try{window.gc()}catch(e){console.log("Manual garbage collection not available")}}},validator={sanitizeHTML:function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML},validateInput:function(e,t=!1){if(null==e)return"";const n=String(e);return t?n:this.sanitizeHTML(n)},isValidKeyName:function(e){return/^[A-Za-z0-9 ._-]{1,50}$/.test(e)},isValidEncryptedMessage:function(e){return/^--LM--\s*[A-Za-z0-9+/=]+\s*--EM--$/s.test(e)},measurePasswordStrength:function(e){let t=0;if(!e)return{score:0,feedback:"Password is required"};const n=e.length;let a,r;return t+=Math.min(5,Math.floor(n/4)),/[a-z]/.test(e)&&(t+=1),/[A-Z]/.test(e)&&(t+=1),/[0-9]/.test(e)&&(t+=1),/[^A-Za-z0-9]/.test(e)&&(t+=2),/^[a-zA-Z]+$/.test(e)&&(t-=1),/^[0-9]+$/.test(e)&&(t-=1),/(.)\1{2,}/.test(e)&&(t-=1),t<4?(a="weak",r="Weak - Use a longer password with numbers and special characters"):t<8?(a="medium",r="Medium - Add more variety or length for better security"):(a="strong",r="Strong - Good password!"),{score:t,strengthCategory:a,feedback:r}}};async function initDatabase(){return window.indexedDB?new Promise(((e,t)=>{const n=indexedDB.open(DB_NAME,1);n.onupgradeneeded=function(e){const t=e.target.result;t.objectStoreNames.contains("keys")||t.createObjectStore("keys",{keyPath:"id"}),t.objectStoreNames.contains("settings")||t.createObjectStore("settings",{keyPath:"id"})},n.onsuccess=function(t){db=t.target.result,console.log("Database initialized successfully"),e()},n.onerror=function(t){console.error("Database error:",t.target.error),showStatus("keyStatus","Database initialization failed. Using less secure localStorage instead.","warning"),appSettings.useIndexedDB=!1,e()}})):(showStatus("keyStatus","Your browser doesn't support secure storage. Using less secure localStorage instead.","warning"),void(appSettings.useIndexedDB=!1))}function switchTab(e){console.log("Switching to tab:",e),tabBtns.forEach((t=>{t.getAttribute("data-tab")===e?t.classList.add("active"):t.classList.remove("active")})),document.getElementById("encryptMessage").value="",document.getElementById("encryptedOutput").value="",document.getElementById("encryptStatus").className="status",document.getElementById("encryptStatus").textContent="",document.getElementById("encryptionKey").value="",document.getElementById("encryptionPassword").value="",document.getElementById("encryptionPasswordGroup").style.display="none",clearEncryptFile(),document.getElementById("encryptedMessage").value="",document.getElementById("decryptedOutput").value="",document.getElementById("decryptStatus").className="status",document.getElementById("decryptStatus").textContent="",document.getElementById("decryptionKey").value="",document.getElementById("decryptionPassword").value="",document.getElementById("decryptionPasswordGroup").style.display="none",clearDecryptFile(),window.decryptedBinaryData=null,document.getElementById("encrypt").classList.remove("active"),document.getElementById("decrypt").classList.remove("active"),document.getElementById("keys").classList.remove("active"),document.getElementById("settings").classList.remove("active"),document.getElementById(e).classList.add("active")}function setLoading(e){loadingOverlay.style.display=e?"flex":"none"}async function loadSettings(){if(appSettings.useIndexedDB&&db)try{const e=await getFromDatabase("settings","app-settings");e&&(appSettings={...DEFAULT_SETTINGS,...e})}catch(e){console.error("Error loading settings from database:",e);try{const e=localStorage.getItem("LemonadeSettings");e&&(appSettings={...DEFAULT_SETTINGS,...JSON.parse(e)})}catch(e){console.error("Error loading settings from localStorage:",e)}}else try{const e=localStorage.getItem("LemonadeSettings");e&&(appSettings={...DEFAULT_SETTINGS,...JSON.parse(e)})}catch(e){console.error("Error loading settings from localStorage:",e)}return PBKDF2_CONFIG.ITERATIONS=appSettings.pbkdf2Iterations,appSettings}function initSettingsUI(){document.getElementById("useIndexedDB").checked=appSettings.useIndexedDB,document.getElementById("sessionOnly").checked=appSettings.sessionOnly,document.getElementById("enforcePwdProtection").checked=appSettings.enforcePwdProtection,document.getElementById("enforceKeyExpiry").checked=appSettings.enforceKeyExpiry,document.getElementById("pbkdf2Iterations").value=appSettings.pbkdf2Iterations}async function saveSettings(){try{appSettings.useIndexedDB=document.getElementById("useIndexedDB").checked,appSettings.sessionOnly=document.getElementById("sessionOnly").checked,appSettings.enforcePwdProtection=document.getElementById("enforcePwdProtection").checked,appSettings.enforceKeyExpiry=document.getElementById("enforceKeyExpiry").checked,appSettings.pbkdf2Iterations=parseInt(document.getElementById("pbkdf2Iterations").value),PBKDF2_CONFIG.ITERATIONS=appSettings.pbkdf2Iterations,appSettings.useIndexedDB&&db?await saveToDatabase("settings",{id:"app-settings",...appSettings}):localStorage.setItem("LemonadeSettings",JSON.stringify(appSettings)),showStatus("settingsStatus","Settings saved successfully","success")}catch(e){console.error("Error saving settings:",e),showStatus("settingsStatus","Error saving settings: "+e.message,"error")}}function resetSettings(){confirm("Are you sure you want to reset all settings to defaults?")&&(appSettings={...DEFAULT_SETTINGS},initSettingsUI(),saveSettings())}function updatePasswordStrength(){const e=document.getElementById("keyPassword").value,t=validator.measurePasswordStrength(e),n=document.getElementById("passwordStrength"),a=document.getElementById("passwordFeedback");n.className="password-strength",e?(n.classList.add(t.strengthCategory),a.textContent=t.feedback):a.textContent=""}async function loadKeys(){try{if(keys=[],appSettings.useIndexedDB&&db){const e=await getAllFromDatabase("keys");e&&e.length>0&&(keys=e)}else{const e=localStorage.getItem("LemonadeKeys");e&&(keys=JSON.parse(e))}checkExpiredKeys(),updateKeysList(),updateKeySelects()}catch(e){console.error("Error loading keys:",e),showStatus("keyStatus","Error loading keys: "+e.message,"error")}}async function saveKeys(){try{if(appSettings.sessionOnly)console.log("Session-only mode: Keys not saved persistently");else if(appSettings.useIndexedDB&&db){await clearDatabase("keys");for(const e of keys)await saveToDatabase("keys",e)}else localStorage.setItem("LemonadeKeys",JSON.stringify(keys));updateKeysList(),updateKeySelects()}catch(e){console.error("Error saving keys:",e),showStatus("keyStatus","Error saving keys: "+e.message,"error")}}function checkExpiredKeys(){const e=new Date,t=[];keys.forEach((n=>{if(n.expiry){new Date(n.expiry)<e&&t.push(n.id)}})),t.length>0&&(keys=keys.filter((e=>!t.includes(e.id))),saveKeys(),showStatus("keyStatus",`${t.length} expired key(s) removed for security`,"warning"))}async function generateKey(){try{setLoading(!0);const e=document.getElementById("keyName").value.trim(),t=document.getElementById("keyType").value,n=document.getElementById("keyPassword").value,a=document.getElementById("confirmKeyPassword").value,r=document.getElementById("keyExpiry").value;if(!e)return void showStatus("keyStatus","Please enter a key name","error");if(!validator.isValidKeyName(e))return void showStatus("keyStatus","Key name can only contain letters, numbers, spaces, and basic punctuation (._-)","error");if(appSettings.enforcePwdProtection&&!n)return void showStatus("keyStatus","Password protection is required by your security settings","error");if(n){const e=validator.measurePasswordStrength(n);if(e.score<4)return void showStatus("keyStatus","Please use a stronger password: "+e.feedback,"error");if(n!==a)return void showStatus("keyStatus","Passwords do not match","error")}if(appSettings.enforceKeyExpiry&&!r)return void showStatus("keyStatus","Key expiration is required by your security settings","error");const s={id:crypto.randomUUID(),name:e,type:t,created:(new Date).toISOString()};if(r){const e=parseInt(r),t=new Date;t.setDate(t.getDate()+e),s.expiry=t.toISOString()}("rsa"===t||"rsa-4096"===t||"ecc"===t||"ecc-p384"===t)&&(s.hasPublic=!0,s.hasPrivate=!0,s.pairedKeyId=s.id),"aes"===t?await generateAESKey(s,n):"rsa"===t?await generateRSAKey(s,n,RSA_CONFIG.KEY_SIZE):"rsa-4096"===t?await generateRSAKey(s,n,RSA_CONFIG.KEY_SIZE_4096):"ecc"===t?await generateECCKey(s,n,ECC_CONFIG.CURVE):"ecc-p384"===t&&await generateECCKey(s,n,ECC_CONFIG.CURVE_P384),keys.push(s),await saveKeys(),document.getElementById("keyName").value="",document.getElementById("keyPassword").value="",document.getElementById("confirmKeyPassword").value="",document.getElementById("passwordStrength").className="password-strength",document.getElementById("passwordFeedback").textContent="";showStatus("keyStatus",`${getKeyTypeDisplay(s)} key "${e}" generated successfully`,"success")}catch(e){console.error("Error generating key:",e),showStatus("keyStatus","Error generating key: "+e.message,"error")}finally{setLoading(!1)}}function getPairedKeyIds(e){if(e.pairedKeyId)return e.pairedKeyId;if(e.hasPrivate&&e.hasPublic)return e.id;if(("rsa"===e.type||"rsa-4096"===e.type||"ecc"===e.type||"ecc-p384"===e.type)&&(e.hasPublic||e.hasPrivate)){const t=keys.filter((t=>t.id!==e.id&&t.type===e.type&&(e.hasPublic&&t.hasPrivate||e.hasPrivate&&t.hasPublic)&&t.publicKeyHash&&e.publicKeyHash&&t.publicKeyHash===e.publicKeyHash));if(t.length>0)return t[0].id}return null}function zeroAllKeys(){if(0===keys.length)return void showStatus("keyStatus","No keys to delete","warning");if(confirm("WARNING: This will permanently delete ALL your encryption keys. This action CANNOT be undone.\n\nAre you absolutely sure you want to continue?")){const e=keys.length;keys=[],appSettings.useIndexedDB&&db?clearDatabase("keys").then((()=>{console.log("All keys cleared from database")})).catch((e=>{console.error("Error clearing keys from database:",e)})):localStorage.removeItem("LemonadeKeys"),updateKeysList(),updateKeySelects(),showStatus("keyStatus",`All keys (${e}) have been permanently deleted`,"success")}else showStatus("keyStatus","Key deletion canceled","info")}async function generateAESKey(e,t){const n=await window.crypto.subtle.generateKey({name:AES_CONFIG.MODE,length:AES_CONFIG.KEY_LENGTH},!0,["encrypt","decrypt"]),a=await window.crypto.subtle.exportKey("raw",n);e.key=arrayBufferToBase64(a),e.algorithm=AES_CONFIG.MODE,e.length=AES_CONFIG.KEY_LENGTH,t&&await encryptKeyWithPassword(e,t)}async function generateRSAKey(e,t,n){const a=await window.crypto.subtle.generateKey({name:RSA_CONFIG.ALGORITHM,modulusLength:n,publicExponent:new Uint8Array([1,0,1]),hash:RSA_CONFIG.HASH},!0,["encrypt","decrypt"]),r=await window.crypto.subtle.exportKey("spki",a.publicKey),s=await window.crypto.subtle.exportKey("pkcs8",a.privateKey);e.publicKey=arrayBufferToBase64(r),e.privateKey=arrayBufferToBase64(s),e.algorithm=RSA_CONFIG.ALGORITHM,e.length=n;const o=await computeKeyHash(r);e.publicKeyHash=o,t&&await encryptKeyWithPassword(e,t)}async function generateECCKey(e,t,n){const a=await window.crypto.subtle.generateKey({name:"ECDH",namedCurve:n},!0,["deriveKey","deriveBits"]),r=await window.crypto.subtle.exportKey("spki",a.publicKey),s=await window.crypto.subtle.exportKey("pkcs8",a.privateKey);e.publicKey=arrayBufferToBase64(r),e.privateKey=arrayBufferToBase64(s),e.algorithm="ECDH",e.curve=n;const o=await computeKeyHash(r);e.publicKeyHash=o,t&&await encryptKeyWithPassword(e,t)}async function computeKeyHash(e){return arrayBufferToBase64(await crypto.subtle.digest("SHA-256",e))}async function encryptKeyWithPassword(e,t){const n=window.crypto.getRandomValues(new Uint8Array(16));e.salt=arrayBufferToBase64(n);const a=await deriveKeyFromPassword(t,n),r=window.crypto.getRandomValues(new Uint8Array(AES_CONFIG.IV_LENGTH));if(e.iv=arrayBufferToBase64(r),"aes"===e.type){const t=await encryptWithDerivedKey(a,base64ToArrayBuffer(e.key),r);e.key=arrayBufferToBase64(t),e.protected=!0}else{const t=await encryptWithDerivedKey(a,base64ToArrayBuffer(e.privateKey),r);e.privateKey=arrayBufferToBase64(t),e.protected=!0}}async function decryptKeyWithPassword(e,t){try{if(!e||!t)throw new Error("Key data and password are required");if(!e.salt||!e.iv)throw new Error("Key is missing salt or IV data");const n=base64ToArrayBuffer(e.salt),a=await deriveKeyFromPassword(t,n),r=base64ToArrayBuffer(e.iv),s={...e};if("aes"===e.type){if(!e.key)throw new Error("Missing encrypted key data");const t=await decryptWithDerivedKey(a,base64ToArrayBuffer(e.key),r);s.key=arrayBufferToBase64(t),s._cryptoKey=await importAESKey(t)}else if("rsa"===e.type||"rsa-4096"===e.type){if(!e.privateKey)throw new Error("Missing encrypted private key data");const t=await decryptWithDerivedKey(a,base64ToArrayBuffer(e.privateKey),r);s.privateKey=arrayBufferToBase64(t),s._privateKey=await importRSAPrivateKey(t,e.length||RSA_CONFIG.KEY_SIZE),e.publicKey&&(s._publicKey=await importRSAPublicKey(base64ToArrayBuffer(e.publicKey),e.length||RSA_CONFIG.KEY_SIZE))}else{if("ecc"!==e.type&&"ecc-p384"!==e.type)throw new Error("Unsupported key type: "+e.type);{if(!e.privateKey)throw new Error("Missing encrypted private key data");const t=await decryptWithDerivedKey(a,base64ToArrayBuffer(e.privateKey),r);s.privateKey=arrayBufferToBase64(t),s._privateKey=await importECCPrivateKey(t,e.curve||ECC_CONFIG.CURVE),e.publicKey&&(s._publicKey=await importECCPublicKey(base64ToArrayBuffer(e.publicKey),e.curve||ECC_CONFIG.CURVE))}}return safeMemory.store(s)}catch(e){throw console.error("Decryption error:",e),new Error("Incorrect password or corrupted private key")}}function updateKeysList(){keysList.innerHTML="",0!==keys.length?keys.forEach((e=>{const t=document.createElement("div");t.className="key-item";const n=getKeyTypeDisplay(e),a=e.protected?" 🔒":"";let r="";"aes"===e.type?r="":e.hasPrivate&&e.hasPublic?r='<span class="key-pair-badge full">FULL KEY PAIR</span>':e.hasPrivate?r='<span class="key-pair-badge private">PRIVATE KEY</span>':e.hasPublic&&(r='<span class="key-pair-badge public">PUBLIC KEY</span>');let s="",o=determineKeySecurityLevel(e);s=`<span class="security-badge ${o}">${o.toUpperCase()}</span>`;let i="";if(e.expiry){const t=new Date(e.expiry);i=`<div class="key-expiry">Expires in ${Math.ceil((t-new Date)/864e5)} days (${t.toLocaleDateString()})</div>`}let c="";"aes"===e.type?c+=`<button class="btn-secondary" onclick="exportKey('${e.id}')">Export</button>`:e.hasPublic&&(c+=`<button class="btn-secondary" onclick="exportKey('${e.id}')">Export Public</button>`),"aes"!==e.type&&e.hasPrivate&&(c+=`<button class="btn-secondary private-key-btn" onclick="exportPrivateKey('${e.id}')">Private Key</button>`),c+=`<button class="btn-secondary" onclick="deleteKey('${e.id}')">Delete</button>`,t.innerHTML=`\n            <div class="key-header">\n                <h3>${validator.sanitizeHTML(e.name)} (${n}${a}) ${s}</h3>\n                ${r}\n            </div>\n            <div class="key-meta">Created: ${new Date(e.created).toLocaleString()}</div>\n            <div class="key-meta">Algorithm: ${e.algorithm||""} ${e.length?e.length+" bits":e.curve||""}</div>\n            ${i}\n            <div class="key-actions">\n                ${c}\n            </div>\n        `,keysList.appendChild(t)})):keysList.innerHTML="<p>No keys available. Generate or import a key to get started.</p>"}function getKeyTypeDisplay(e){return"aes"===e.type?"AES":"rsa"===e.type?"RSA-2048":"rsa-4096"===e.type?"RSA-4096":"ecc"===e.type?"ECC-P256":"ecc-p384"===e.type?"ECC-P384":e.type.toUpperCase()}function updateKeySelects(){encryptionKeySelect.innerHTML='<option value="">Select a key...</option>',decryptionKeySelect.innerHTML='<option value="">Select a key...</option>',keys.forEach((e=>{if("aes"===e.type||e.hasPublic){const t=document.createElement("option");t.value=e.id;const n=getKeyTypeDisplay(e),a=e.protected?" 🔒":"";let r="";"aes"!==e.type&&(r=e.hasPrivate&&e.hasPublic?" [Full Pair]":" [Public]"),t.text=`${e.name} (${n}${r}${a})`,encryptionKeySelect.appendChild(t)}})),keys.forEach((e=>{if("aes"===e.type||e.hasPrivate){const t=document.createElement("option");t.value=e.id;const n=getKeyTypeDisplay(e),a=e.protected?" 🔒":"";let r="";"aes"!==e.type&&(r=e.hasPrivate&&e.hasPublic?" [Full Pair]":" [Private]"),t.text=`${e.name} (${n}${r}${a})`,decryptionKeySelect.appendChild(t)}}))}function handleEncryptionKeyChange(){const e=encryptionKeySelect.value;if(!e)return void(document.getElementById("encryptionPasswordGroup").style.display="none");const t=keys.find((t=>t.id===e));t&&(document.getElementById("encryptionPasswordGroup").style.display=t.protected?"block":"none")}function handleDecryptionKeyChange(){const e=decryptionKeySelect.value;if(!e)return void(document.getElementById("decryptionPasswordGroup").style.display="none");const t=keys.find((t=>t.id===e));t&&(document.getElementById("decryptionPasswordGroup").style.display=t.protected?"block":"none")}async function encryptMessage(){try{let e,t="";if(encryptFileData)e=encryptFileData,t=generateRandomFileName(6)+".lmn";else{const t=document.getElementById("encryptMessage").value;if(!t)return void showStatus("encryptStatus","Please enter a message or add a file to encrypt","error");e=(new TextEncoder).encode(t)}const n=document.getElementById("encryptionKey").value,a=document.getElementById("encryptionPassword").value;if(!n)return void showStatus("encryptStatus","Please select an encryption key","error");setLoading(!0);const r=keys.find((e=>e.id===n));if(!r)return void showStatus("encryptStatus","Key not found","error");let s=null,o=r;if(r.protected){if(!a)return void showStatus("encryptStatus","Password required for this key","error");s=await decryptKeyWithPassword(r,a),o=safeMemory.retrieve(s)}let i=await encryptData(e,o);s&&safeMemory.delete(s),encryptFileData&&(i.fileName=encryptFileName,i.fileSize=encryptFileData.byteLength,i.isFile=!0);const c=createEncryptedMessageString(i);document.getElementById("encryptedOutput").value=c,document.getElementById("downloadEncryptedBtn").setAttribute("data-filename",t),showStatus("encryptStatus","Message encrypted successfully","success")}catch(e){console.error("Encryption error:",e),showStatus("encryptStatus","Encryption error: "+e.message,"error")}finally{document.getElementById("encryptionPassword").value="",setLoading(!1)}}async function encryptWithAES(e,t){try{const n=window.crypto.getRandomValues(new Uint8Array(AES_CONFIG.IV_LENGTH));let a;if(t._cryptoKey)a=t._cryptoKey;else{const e=base64ToArrayBuffer(t.key);a=await window.crypto.subtle.importKey("raw",e,{name:AES_CONFIG.MODE,length:AES_CONFIG.KEY_LENGTH},!1,["encrypt"])}const r=await window.crypto.subtle.encrypt({name:AES_CONFIG.MODE,iv:n,tagLength:AES_CONFIG.TAG_LENGTH},a,e),s={k:t.id,t:(new Date).toISOString(),a:AES_CONFIG.MODE};encryptFileData&&encryptFileName&&(s.f={n:encryptFileName,s:encryptFileData.byteLength});const o=(new TextEncoder).encode(JSON.stringify(s)),i=window.crypto.getRandomValues(new Uint8Array(AES_CONFIG.IV_LENGTH)),c=await window.crypto.subtle.generateKey({name:AES_CONFIG.MODE,length:AES_CONFIG.KEY_LENGTH},!0,["encrypt"]),d=await window.crypto.subtle.encrypt({name:AES_CONFIG.MODE,iv:i,tagLength:AES_CONFIG.TAG_LENGTH},c,o),y=await window.crypto.subtle.exportKey("raw",c),l=3,u=1+i.byteLength+4+y.byteLength+4+d.byteLength+n.byteLength+4+r.byteLength,p=new Uint8Array(u);let m=0;p[m++]=l,p.set(i,m),m+=i.byteLength;const w=y.byteLength;p[m++]=w>>24&255,p[m++]=w>>16&255,p[m++]=w>>8&255,p[m++]=255&w,p.set(new Uint8Array(y),m),m+=y.byteLength;const g=d.byteLength;p[m++]=g>>24&255,p[m++]=g>>16&255,p[m++]=g>>8&255,p[m++]=255&g,p.set(new Uint8Array(d),m),m+=d.byteLength,p.set(n,m),m+=n.byteLength;const E=r.byteLength;return p[m++]=E>>24&255,p[m++]=E>>16&255,p[m++]=E>>8&255,p[m++]=255&E,p.set(new Uint8Array(r),m),{version:3,data:arrayBufferToBase64(p.buffer)}}catch(e){throw console.error("AES encryption error:",e),new Error("Encryption failed: "+e.message)}}async function deriveMetadataKey(e,t){const n=await window.crypto.subtle.exportKey("raw",e),a=new Uint8Array(n.byteLength+t.byteLength);a.set(new Uint8Array(n),0),a.set(t,n.byteLength);const r=await window.crypto.subtle.importKey("raw",a,{name:"HKDF"},!1,["deriveKey"]);return window.crypto.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:t,info:new Uint8Array([1,2,3,4])},r,{name:AES_CONFIG.MODE,length:AES_CONFIG.KEY_LENGTH},!1,["encrypt","decrypt"])}async function encryptWithRSA(e,t){const n=await window.crypto.subtle.generateKey({name:AES_CONFIG.MODE,length:AES_CONFIG.KEY_LENGTH},!0,["encrypt","decrypt"]),a=window.crypto.getRandomValues(new Uint8Array(AES_CONFIG.IV_LENGTH)),r=await window.crypto.subtle.encrypt({name:AES_CONFIG.MODE,iv:a,tagLength:AES_CONFIG.TAG_LENGTH},n,e),s=await window.crypto.subtle.exportKey("raw",n);let o;if(t._publicKey)o=t._publicKey;else{const e=base64ToArrayBuffer(t.publicKey);o=await importRSAPublicKey(e,t.length||RSA_CONFIG.KEY_SIZE)}const i=await window.crypto.subtle.encrypt({name:RSA_CONFIG.ALGORITHM},o,s),c={a:RSA_CONFIG.ALGORITHM+"+"+AES_CONFIG.MODE,k:t.id,t:(new Date).toISOString(),s:t.length||RSA_CONFIG.KEY_SIZE};encryptFileData&&encryptFileName&&(c.f={n:encryptFileName,s:encryptFileData.byteLength});const d=(new TextEncoder).encode(JSON.stringify(c)),y=await window.crypto.subtle.generateKey({name:AES_CONFIG.MODE,length:AES_CONFIG.KEY_LENGTH},!0,["encrypt","decrypt"]),l=window.crypto.getRandomValues(new Uint8Array(AES_CONFIG.IV_LENGTH)),u=await window.crypto.subtle.encrypt({name:AES_CONFIG.MODE,iv:l,tagLength:AES_CONFIG.TAG_LENGTH},y,d),p=await window.crypto.subtle.exportKey("raw",y),m=Math.floor(64*Math.random())+1,w=window.crypto.getRandomValues(new Uint8Array(m)),g=new Uint8Array(1+l.byteLength+4+p.byteLength+4+u.byteLength+4+i.byteLength+a.byteLength+4+r.byteLength+1+w.byteLength);let E=0;g[E++]=l.byteLength,g.set(l,E),E+=l.byteLength;const h=p.byteLength;g[E++]=h>>24&255,g[E++]=h>>16&255,g[E++]=h>>8&255,g[E++]=255&h,g.set(new Uint8Array(p),E),E+=p.byteLength;const f=u.byteLength;g[E++]=f>>24&255,g[E++]=f>>16&255,g[E++]=f>>8&255,g[E++]=255&f,g.set(new Uint8Array(u),E),E+=u.byteLength;const S=i.byteLength;g[E++]=S>>24&255,g[E++]=S>>16&255,g[E++]=S>>8&255,g[E++]=255&S,g.set(new Uint8Array(i),E),E+=i.byteLength,g.set(a,E),E+=a.byteLength;const I=r.byteLength;return g[E++]=I>>24&255,g[E++]=I>>16&255,g[E++]=I>>8&255,g[E++]=255&I,g.set(new Uint8Array(r),E),E+=r.byteLength,g[E++]=w.byteLength,g.set(w,E),{version:2,data:arrayBufferToBase64(g.buffer)}}async function encryptWithECC(e,t){const n=await window.crypto.subtle.generateKey({name:"ECDH",namedCurve:t.curve||ECC_CONFIG.CURVE},!0,["deriveKey","deriveBits"]),a=await window.crypto.subtle.exportKey("spki",n.publicKey);let r;if(t._publicKey)r=t._publicKey;else{const e=base64ToArrayBuffer(t.publicKey);r=await importECCPublicKey(e,t.curve||ECC_CONFIG.CURVE)}const s=window.crypto.getRandomValues(new Uint8Array(AES_CONFIG.IV_LENGTH)),o=await window.crypto.subtle.deriveBits({name:"ECDH",public:r},n.privateKey,256),i=await window.crypto.subtle.importKey("raw",o,{name:AES_CONFIG.MODE,length:AES_CONFIG.KEY_LENGTH},!1,["encrypt"]),c=await window.crypto.subtle.encrypt({name:AES_CONFIG.MODE,iv:s,tagLength:AES_CONFIG.TAG_LENGTH},i,e),d={a:"ECDH+"+AES_CONFIG.MODE,k:t.id,t:(new Date).toISOString(),c:t.curve||ECC_CONFIG.CURVE};encryptFileData&&encryptFileName&&(d.f={n:encryptFileName,s:encryptFileData.byteLength});const y=(new TextEncoder).encode(JSON.stringify(d)),l=await window.crypto.subtle.generateKey({name:AES_CONFIG.MODE,length:AES_CONFIG.KEY_LENGTH},!0,["encrypt","decrypt"]),u=window.crypto.getRandomValues(new Uint8Array(AES_CONFIG.IV_LENGTH)),p=await window.crypto.subtle.encrypt({name:AES_CONFIG.MODE,iv:u,tagLength:AES_CONFIG.TAG_LENGTH},l,y),m=await window.crypto.subtle.exportKey("raw",l),w=Math.floor(64*Math.random())+1,g=window.crypto.getRandomValues(new Uint8Array(w)),E=new Uint8Array(1+u.byteLength+4+m.byteLength+4+p.byteLength+4+a.byteLength+s.byteLength+4+c.byteLength+1+g.byteLength);let h=0;E[h++]=u.byteLength,E.set(u,h),h+=u.byteLength;const f=m.byteLength;E[h++]=f>>24&255,E[h++]=f>>16&255,E[h++]=f>>8&255,E[h++]=255&f,E.set(new Uint8Array(m),h),h+=m.byteLength;const S=p.byteLength;E[h++]=S>>24&255,E[h++]=S>>16&255,E[h++]=S>>8&255,E[h++]=255&S,E.set(new Uint8Array(p),h),h+=p.byteLength;const I=a.byteLength;E[h++]=I>>24&255,E[h++]=I>>16&255,E[h++]=I>>8&255,E[h++]=255&I,E.set(new Uint8Array(a),h),h+=a.byteLength,E.set(s,h),h+=s.byteLength;const v=c.byteLength;return E[h++]=v>>24&255,E[h++]=v>>16&255,E[h++]=v>>8&255,E[h++]=255&v,E.set(new Uint8Array(c),h),h+=c.byteLength,E[h++]=g.byteLength,E.set(g,h),{version:2,data:arrayBufferToBase64(E.buffer)}}async function decryptMessage(){try{let e;const t=document.getElementById("encryptedMessage").value;if(!t)return void showStatus("decryptStatus","Please enter an encrypted message or add an encrypted file","error");if(!isValidEncryptedMessage(t))return void showStatus("decryptStatus","Invalid encrypted message format","error");try{e=parseEncryptedMessage(t)}catch(e){return void showStatus("decryptStatus","Invalid encrypted message data: "+e.message,"error")}const n=document.getElementById("decryptionKey").value,a=document.getElementById("decryptionPassword").value;if(!n)return void showStatus("decryptStatus","Please select a decryption key","error");setLoading(!0);const r=keys.find((e=>e.id===n));if(!r)return void showStatus("decryptStatus","Key not found","error");let s=null,o=r;if(r.protected){if(!a)return void showStatus("decryptStatus","Password required for this key","error");s=await decryptKeyWithPassword(r,a),o=safeMemory.retrieve(s)}let i,c,d=await decryptData(e,o);d.data?(i=d.data,c=d.metadata):(i=d,c=null),s&&safeMemory.delete(s);let y=!1,l=null,u=null;if(!e.version&&e.isFile&&e.fileName?(y=!0,l=e.fileName,u=e.fileSize||i.byteLength):c&&c.f&&(y=!0,l=c.f.n,u=c.f.s||i.byteLength),y)document.getElementById("decryptedOutput").value=`File: ${l} (${formatFileSize(u)})`,document.getElementById("downloadDecryptedBtn").setAttribute("data-filename",l),document.getElementById("downloadDecryptedBtn").setAttribute("data-binary","true"),window.decryptedBinaryData=i;else{const e=(new TextDecoder).decode(i);document.getElementById("decryptedOutput").value=e,document.getElementById("downloadDecryptedBtn").setAttribute("data-filename","decrypted.txt"),document.getElementById("downloadDecryptedBtn").setAttribute("data-binary","false"),window.decryptedBinaryData=null}showStatus("decryptStatus","Message decrypted successfully","success")}catch(e){console.error("Decryption error:",e),showStatus("decryptStatus","Decryption error: "+e.message,"error")}finally{document.getElementById("decryptionPassword").value="",setLoading(!1)}}async function decryptWithAES(e,t){try{const n=base64ToArrayBuffer(e.data),a=new Uint8Array(n);let r=0;if(3!==a[r++])throw new Error("Unsupported data format version");const s=a.slice(r,r+AES_CONFIG.IV_LENGTH);r+=AES_CONFIG.IV_LENGTH;const o=a[r]<<24|a[r+1]<<16|a[r+2]<<8|a[r+3];r+=4;const i=a.slice(r,r+o);r+=o;const c=a[r]<<24|a[r+1]<<16|a[r+2]<<8|a[r+3];r+=4;const d=a.slice(r,r+c);r+=c;const y=a.slice(r,r+AES_CONFIG.IV_LENGTH);r+=AES_CONFIG.IV_LENGTH;const l=a[r]<<24|a[r+1]<<16|a[r+2]<<8|a[r+3];r+=4;const u=a.slice(r,r+l),p=await window.crypto.subtle.importKey("raw",i,{name:AES_CONFIG.MODE,length:AES_CONFIG.KEY_LENGTH},!1,["decrypt"]),m=await window.crypto.subtle.decrypt({name:AES_CONFIG.MODE,iv:s,tagLength:AES_CONFIG.TAG_LENGTH},p,d),w=(new TextDecoder).decode(m),g=JSON.parse(w);if(g.k!==t.id)throw new Error("Key ID mismatch - wrong key for this message");let E;if(t._cryptoKey)E=t._cryptoKey;else{const e=base64ToArrayBuffer(t.key);E=await window.crypto.subtle.importKey("raw",e,{name:AES_CONFIG.MODE,length:AES_CONFIG.KEY_LENGTH},!1,["decrypt"])}return{data:await window.crypto.subtle.decrypt({name:AES_CONFIG.MODE,iv:y,tagLength:AES_CONFIG.TAG_LENGTH},E,u),metadata:g}}catch(e){throw console.error("AES Decryption error:",e),e instanceof DOMException?new Error(`Decryption failed: ${e.name} - ${e.message||"Unknown WebCrypto error"}`):new Error("Decryption failed: "+e.message)}}function updateEncryptionOutput(e){return`@!\n${e.data}\n!@`}function createEncryptedMessageString(e){return`@!\n${e.data}\n!@`}function parseEncryptedMessage(e){const t=e.match(/@!([\s\S]+?)!@/);if(!t||!t[1])throw new Error("Invalid encrypted message format");return{version:2,data:t[1].trim()}}function isValidEncryptedMessage(e){return/^@!\s*[A-Za-z0-9+/=]+\s*!@$/s.test(e)}function determineKeySecurityLevel(e){let t="low";"aes"===e.type||"rsa-4096"===e.type||"ecc-p384"===e.type?t="medium":"rsa"!==e.type&&"ecc"!==e.type||(t="low");let n,a=0;return e.protected&&(a+=2),"aes"!==e.type&&e.hasPublic&&e.hasPrivate&&(a+=1),e.expiry&&(a+=1),n="medium"===t?a>=3?"high":a>=1?"medium":"low":a>=4?"high":a>=2?"medium":"low",n}async function decryptWithRSA(e,t){if(e.version&&1!==e.version){const n=base64ToArrayBuffer(e.data),a=new Uint8Array(n);let r=0;const s=a[r++],o=a.slice(r,r+s);r+=s;const i=a[r]<<24|a[r+1]<<16|a[r+2]<<8|a[r+3];r+=4;const c=a.slice(r,r+i);r+=i;const d=a[r]<<24|a[r+1]<<16|a[r+2]<<8|a[r+3];r+=4;const y=a.slice(r,r+d);r+=d;const l=a[r]<<24|a[r+1]<<16|a[r+2]<<8|a[r+3];r+=4;const u=a.slice(r,r+l);r+=l;const p=a.slice(r,r+AES_CONFIG.IV_LENGTH);r+=AES_CONFIG.IV_LENGTH;const m=a[r]<<24|a[r+1]<<16|a[r+2]<<8|a[r+3];r+=4;const w=a.slice(r,r+m);let g;if(t._privateKey)g=t._privateKey;else{const e=base64ToArrayBuffer(t.privateKey);g=await importRSAPrivateKey(e,t.length||RSA_CONFIG.KEY_SIZE)}const E=await window.crypto.subtle.decrypt({name:RSA_CONFIG.ALGORITHM},g,u),h=await window.crypto.subtle.importKey("raw",c,{name:AES_CONFIG.MODE,length:8*i},!1,["decrypt"]),f=await window.crypto.subtle.decrypt({name:AES_CONFIG.MODE,iv:o,tagLength:AES_CONFIG.TAG_LENGTH},h,y),S=(new TextDecoder).decode(f),I=JSON.parse(S);if(I.k!==t.id)throw new Error("Key ID mismatch - wrong key for this message");const v=await importAESKey(E);return{data:await window.crypto.subtle.decrypt({name:AES_CONFIG.MODE,iv:p,tagLength:AES_CONFIG.TAG_LENGTH},v,w),metadata:I}}{const n=base64ToArrayBuffer(e.data),a=base64ToArrayBuffer(e.encryptedKey),r=base64ToArrayBuffer(e.iv);let s;if(t._privateKey)s=t._privateKey;else{const n=base64ToArrayBuffer(t.privateKey);s=await importRSAPrivateKey(n,e.keySize||t.length||RSA_CONFIG.KEY_SIZE)}const o=await window.crypto.subtle.decrypt({name:RSA_CONFIG.ALGORITHM},s,a),i=await importAESKey(o);return await window.crypto.subtle.decrypt({name:AES_CONFIG.MODE,iv:r,tagLength:AES_CONFIG.TAG_LENGTH},i,n)}}async function decryptWithECC(e,t){if(e.version&&1!==e.version){const n=base64ToArrayBuffer(e.data),a=new Uint8Array(n);let r=0;const s=a[r++],o=a.slice(r,r+s);r+=s;const i=a[r]<<24|a[r+1]<<16|a[r+2]<<8|a[r+3];r+=4;const c=a.slice(r,r+i);r+=i;const d=a[r]<<24|a[r+1]<<16|a[r+2]<<8|a[r+3];r+=4;const y=a.slice(r,r+d);r+=d;const l=a[r]<<24|a[r+1]<<16|a[r+2]<<8|a[r+3];r+=4;const u=a.slice(r,r+l);r+=l;const p=a.slice(r,r+AES_CONFIG.IV_LENGTH);r+=AES_CONFIG.IV_LENGTH;const m=a[r]<<24|a[r+1]<<16|a[r+2]<<8|a[r+3];r+=4;const w=a.slice(r,r+m),g=await importECCPublicKey(u,t.curve||ECC_CONFIG.CURVE);let E;if(t._privateKey)E=t._privateKey;else{const e=base64ToArrayBuffer(t.privateKey);E=await importECCPrivateKey(e,t.curve||ECC_CONFIG.CURVE)}const h=await window.crypto.subtle.deriveBits({name:"ECDH",public:g},E,256),f=await window.crypto.subtle.importKey("raw",h,{name:AES_CONFIG.MODE,length:AES_CONFIG.KEY_LENGTH},!1,["decrypt"]),S=await window.crypto.subtle.importKey("raw",c,{name:AES_CONFIG.MODE,length:8*i},!1,["decrypt"]),I=await window.crypto.subtle.decrypt({name:AES_CONFIG.MODE,iv:o,tagLength:AES_CONFIG.TAG_LENGTH},S,y),v=(new TextDecoder).decode(I),b=JSON.parse(v);if(b.k!==t.id)throw new Error("Key ID mismatch - wrong key for this message");return{data:await window.crypto.subtle.decrypt({name:AES_CONFIG.MODE,iv:p,tagLength:AES_CONFIG.TAG_LENGTH},f,w),metadata:b}}{const n=base64ToArrayBuffer(e.data),a=base64ToArrayBuffer(e.ephemeralPublicKey),r=base64ToArrayBuffer(e.iv),s=await importECCPublicKey(a,e.curve||ECC_CONFIG.CURVE);let o;if(t._privateKey)o=t._privateKey;else{const n=base64ToArrayBuffer(t.privateKey);o=await importECCPrivateKey(n,e.curve||ECC_CONFIG.CURVE)}const i=await window.crypto.subtle.deriveKey({name:"ECDH",public:s},o,{name:AES_CONFIG.MODE,length:AES_CONFIG.KEY_LENGTH},!1,["decrypt"]);return await window.crypto.subtle.decrypt({name:AES_CONFIG.MODE,iv:r,tagLength:AES_CONFIG.TAG_LENGTH},i,n)}}function downloadEncryptedFile(){const e=document.getElementById("encryptedOutput").value;if(!e)return void showStatus("encryptStatus","No encrypted data to download","error");const t=document.getElementById("downloadEncryptedBtn").getAttribute("data-filename")||generateRandomFileName(6)+".lmn";downloadBlob(new Blob([e],{type:"application/octet-stream"}),t),showStatus("encryptStatus",`File "${t}" downloaded successfully`,"success")}function downloadDecryptedFile(){if(window.decryptedBinaryData){const e=document.getElementById("downloadDecryptedBtn").getAttribute("data-filename")||"decrypted_file";downloadBlob(new Blob([window.decryptedBinaryData],{type:"application/octet-stream"}),e)}else{const e=document.getElementById("decryptedOutput").value;if(!e)return void showStatus("decryptStatus","No decrypted data to download","error");const t=document.getElementById("downloadDecryptedBtn").getAttribute("data-filename")||"decrypted.txt";downloadBlob(new Blob([e],{type:"application/octet-stream"}),t)}showStatus("decryptStatus","File downloaded successfully","success")}function downloadBlob(e,t){const n=URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}function importKey(){createKeyFileInput().click()}async function exportKey(e,t=!1){try{const n=keys.find((t=>t.id===e));if(!n)return void alert("Key not found");const a="rsa"===n.type||"rsa-4096"===n.type||"ecc"===n.type||"ecc-p384"===n.type;let r=n,s=".lim";if(a&&t){let e="";try{e=await showPasswordModal("Secure Your Private Key","Please enter a password to protect this private key:",!0)}catch(e){return}if(!e&&!confirm("Warning: Exporting a private key without password protection is a security risk. Continue anyway?"))return;if(r={id:n.id,name:n.name,type:n.type,created:n.created,expiry:n.expiry,privateKey:n.privateKey,protected:n.protected,salt:n.salt,iv:n.iv,algorithm:n.algorithm,hasPrivate:!0,hasPublic:!1,pairedKeyId:n.id,publicKeyHash:n.publicKeyHash},"rsa"===n.type||"rsa-4096"===n.type?r.length=n.length:"ecc"!==n.type&&"ecc-p384"!==n.type||(r.curve=n.curve),e){if(n.protected)try{const e=await showPasswordModal("Enter Current Password","Enter the current key password to continue:",!1),t=await decryptKeyWithPassword(n,e),a=safeMemory.retrieve(t,!0);r.privateKey=a.privateKey,r.protected=!1}catch(e){return void showStatus("keyStatus","Export cancelled: "+e.message,"error")}await encryptKeyWithPassword(r,e)}s=".lem"}else a&&!t&&(r={id:n.id,name:n.name,type:n.type,created:n.created,expiry:n.expiry,publicKey:n.publicKey,algorithm:n.algorithm,hasPublic:!0,hasPrivate:!1,pairedKeyId:n.id,publicKeyHash:n.publicKeyHash},"rsa"===n.type||"rsa-4096"===n.type?r.length=n.length:"ecc"!==n.type&&"ecc-p384"!==n.type||(r.curve=n.curve));const o=JSON.stringify(r),i=btoa(o),c=new Blob([i],{type:"application/octet-stream"}),d=URL.createObjectURL(c),y=document.createElement("a");y.href=d,y.download=`${n.name.replace(/[^a-z0-9]/gi,"_")}${s}`,document.body.appendChild(y),y.click(),document.body.removeChild(y),URL.revokeObjectURL(d);const l=t?"private key":a?"public key":"key";showStatus("keyStatus",`Key "${n.name}" ${l} exported as ${s} file`,"success")}catch(e){console.error("Export error:",e),showStatus("keyStatus","Export error: "+e.message,"error")}}async function exportPrivateKey(e){const t=keys.find((t=>t.id===e));if(!t)return void alert("Key not found");if(!t.hasPrivate)return void showStatus("keyStatus","This key does not have a private key component to export","error");confirm("WARNING: Exporting a private key is a security risk. Only export private keys if you absolutely need to use them on another device. Do you want to continue?")&&await exportKey(e,!0)}function createKeyFileInput(){let e=document.getElementById("keyFileInput");return e||(e=document.createElement("input"),e.type="file",e.id="keyFileInput",e.accept=".lim,.lem",e.style.display="none",document.body.appendChild(e),e.addEventListener("change",handleKeyFileSelect)),e}async function handleKeyFileSelect(e){try{const t=e.target.files;if(!t||0===t.length)return;setLoading(!0);const n=t[0],a=n.name.toLowerCase().endsWith(".lem"),r=n.name.toLowerCase().endsWith(".lim"),s=new FileReader;s.onload=async function(e){try{const t=e.target.result;let n;try{const e=atob(t);n=JSON.parse(e)}catch(e){throw new Error("Invalid key file format")}if(!(n.id&&n.name&&n.type&&n.created))throw new Error("Missing required key properties");if(!validator.isValidKeyName(n.name))throw new Error("Invalid key name format");if("aes"===n.type)n.hasPublic=!0,n.hasPrivate=!0;else{if(n.hasPublic=!!n.publicKey,n.hasPrivate=!!n.privateKey,a&&!n.hasPrivate)throw new Error("This .lem file does not contain a private key");if(r&&!n.hasPublic)throw new Error("This .lim file does not contain a public key")}if(n.hasPrivate&&n.protected){let e="";try{e=await showPasswordModal("Protected Private Key","This private key is password-protected. Please enter the password to import it:",!1)}catch(e){throw new Error("Password is required to import this protected private key")}if(!e)throw new Error("Password is required to import this protected private key");n._importPassword=e}const s=keys.findIndex((e=>e.id===n.id));let o=!1,i=-1;if(s>=0){const e=keys[s];(n.hasPrivate&&!e.hasPrivate&&e.hasPublic||n.hasPublic&&!e.hasPublic&&e.hasPrivate)&&(o=!0,i=s)}else n.publicKeyHash&&(i=keys.findIndex((e=>e.publicKeyHash===n.publicKeyHash&&e.type===n.type&&(e.hasPrivate&&!e.hasPublic&&n.hasPublic||e.hasPublic&&!e.hasPrivate&&n.hasPrivate))),i>=0&&(o=!0));if(o&&i>=0){if(confirm(`This appears to be the ${n.hasPrivate?"private":"public"} key part of an existing key. Would you like to merge them into a complete key pair?`)){const e=keys[i];n.hasPrivate&&!e.hasPrivate&&(e.privateKey=n.privateKey,e.hasPrivate=!0,n.protected&&(e.protected=!0,e.salt=n.salt,e.iv=n.iv)),n.hasPublic&&!e.hasPublic&&(e.publicKey=n.publicKey,e.hasPublic=!0,n.publicKeyHash&&(e.publicKeyHash=n.publicKeyHash)),e.pairedKeyId=e.id,await saveKeys(),showStatus("keyStatus",`Key "${e.name}" updated with ${n.hasPrivate?"private":"public"} key part. Security level: ${determineKeySecurityLevel(e).toUpperCase()}`,"success")}else n.id=crypto.randomUUID(),keys.push(n),await saveKeys(),showStatus("keyStatus",`Key "${n.name}" imported as separate key`,"success")}else if(s>=0){confirm(`A key with name "${n.name}" already exists. Overwrite?`)?keys[s]=n:(n.id=crypto.randomUUID(),keys.push(n)),await saveKeys(),showStatus("keyStatus",`Key "${n.name}" imported successfully`,"success")}else keys.push(n),await saveKeys(),"aes"===n.type?showStatus("keyStatus",`Symmetric key "${n.name}" imported successfully`,"success"):n.hasPrivate&&n.hasPublic?showStatus("keyStatus",`Complete asymmetric key pair "${n.name}" imported successfully`,"success"):n.hasPrivate?showStatus("keyStatus",`Private key "${n.name}" imported successfully`,"success"):showStatus("keyStatus",`Public key "${n.name}" imported successfully`,"success")}catch(e){console.error("Import error:",e),showStatus("keyStatus","Import error: "+e.message,"error")}finally{setLoading(!1),document.getElementById("keyFileInput").value=""}},s.onerror=function(){setLoading(!1),showStatus("keyStatus","Error reading the key file","error"),document.getElementById("keyFileInput").value=""},s.readAsText(n)}catch(e){console.error("Import error:",e),showStatus("keyStatus","Import error: "+e.message,"error"),setLoading(!1),document.getElementById("keyFileInput").value=""}}async function exportAllKeys(){try{if(0===keys.length)return void showStatus("keyStatus","No keys available to export","warning");let e,t="";try{t=await showPasswordModal("Secure Your Key Backup","Please enter a password to protect your key backup. This is highly recommended for security.",!0)}catch(e){return}if(t){const n=JSON.stringify(keys),a=(new TextEncoder).encode(n),r=window.crypto.getRandomValues(new Uint8Array(16)),s=await deriveKeyFromPassword(t,r),o=window.crypto.getRandomValues(new Uint8Array(AES_CONFIG.IV_LENGTH)),i=await encryptWithDerivedKey(s,a,o);e=JSON.stringify({format:"LemonadeProtectedBackup",salt:arrayBufferToBase64(r),iv:arrayBufferToBase64(o),data:arrayBufferToBase64(i)})}else{if(!confirm("WARNING: Exporting keys without a password is not secure. Anyone with access to this file will be able to use your keys. Continue anyway?"))return;e=JSON.stringify(keys)}const n=new Blob([e],{type:"application/octet-stream"}),a=URL.createObjectURL(n),r=document.createElement("a");r.href=a,r.download="Lemonade-state.state",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a),showStatus("keyStatus","Application state exported successfully","success")}catch(e){console.error("Export error:",e),showStatus("keyStatus","Export error: "+e.message,"error")}}function createStateFileInput(){let e=document.getElementById("stateFileInput");return e||(e=document.createElement("input"),e.type="file",e.id="stateFileInput",e.accept=".state,application/octet-stream",e.style.display="none",document.body.appendChild(e),e.addEventListener("change",handleStateFileSelect)),e}async function handleStateFileSelect(e){try{const t=e.target.files;if(!t||0===t.length)return;setLoading(!0);const n=t[0],a=new FileReader;a.onload=async function(e){try{const t=e.target.result;let n;try{n=JSON.parse(t)}catch(e){throw new Error("Invalid state file format")}if("LemonadeProtectedBackup"===n.format){let e="";try{e=await showPasswordModal("Protected State File","This state file is password-protected. Please enter the password to import:",!1)}catch(e){throw new Error("Password is required to import this protected state file")}if(!e)throw new Error("Password is required to import this protected state file");const t=base64ToArrayBuffer(n.salt),a=base64ToArrayBuffer(n.iv),r=base64ToArrayBuffer(n.data),s=await deriveKeyFromPassword(e,t),o=await decryptWithDerivedKey(s,r,a),i=(new TextDecoder).decode(o);n=JSON.parse(i)}if(!Array.isArray(n))throw new Error("Invalid state data format");if(!confirm(`This will import ${n.length} keys into your application. Continue?`))return;keys=n,await saveKeys(),showStatus("keyStatus",`Application state with ${n.length} keys imported successfully`,"success")}catch(e){console.error("State import error:",e),showStatus("keyStatus","State import error: "+e.message,"error")}finally{setLoading(!1),document.getElementById("stateFileInput").value=""}},a.onerror=function(){setLoading(!1),showStatus("keyStatus","Error reading the state file","error"),document.getElementById("stateFileInput").value=""},a.readAsText(n)}catch(e){console.error("State import error:",e),showStatus("keyStatus","State import error: "+e.message,"error"),setLoading(!1),document.getElementById("stateFileInput").value=""}}function importState(){createStateFileInput().click()}async function secureClipboardCopy(e){try{return await navigator.clipboard.writeText(e),!0}catch(e){return console.log("Modern clipboard API failed:",e),!1}}function deleteKey(e){const t=keys.find((t=>t.id===e));if(!t)return void alert("Key not found");window.confirm(`Are you sure you want to delete the key "${t.name}"? This action cannot be undone.`)&&(keys=keys.filter((t=>t.id!==e)),saveKeys(),showStatus("keyStatus",`Key "${t.name}" deleted successfully`,"success"))}function showStatus(e,t,n){const a=document.getElementById(e);a.textContent=validator.sanitizeHTML(t),a.className=`status ${n}`,setTimeout((()=>{a.textContent===validator.sanitizeHTML(t)&&(a.className="status")}),1e4)}document.addEventListener("DOMContentLoaded",(async()=>{document.querySelectorAll(".tab-btn").forEach((e=>{e.addEventListener("click",(t=>{t.preventDefault();const n=e.getAttribute("data-tab");console.log("Tab button clicked:",n),switchTab(n)}))})),document.getElementById("darkMode").addEventListener("change",toggleDarkMode);"true"===localStorage.getItem("LemonadeDarkMode")&&(document.getElementById("darkMode").checked=!0,document.body.classList.add("dark-mode")),document.getElementById("clearEncryptMessageBtn").addEventListener("click",(()=>{clearEncryptFile()})),document.getElementById("clearEncryptedMessageBtn").addEventListener("click",(()=>{clearDecryptFile()})),await initDatabase(),await loadSettings(),initSettingsUI(),await loadKeys(),document.getElementById("keyPassword").addEventListener("input",updatePasswordStrength),document.getElementById("encryptBtn").addEventListener("click",encryptMessage),document.getElementById("decryptBtn").addEventListener("click",decryptMessage),document.getElementById("generateKeyBtn").addEventListener("click",generateKey),document.getElementById("copyEncryptedBtn").addEventListener("click",(()=>copyToClipboard("encryptedOutput","encryptStatus"))),document.getElementById("copyDecryptedBtn").addEventListener("click",(()=>copyToClipboard("decryptedOutput","decryptStatus"))),document.getElementById("clearEncryptBtn").addEventListener("click",(()=>{document.getElementById("encryptMessage").value="",document.getElementById("encryptedOutput").value="",document.getElementById("encryptStatus").className="status",document.getElementById("encryptStatus").textContent="",clearEncryptFile()})),document.getElementById("clearDecryptBtn").addEventListener("click",(()=>{document.getElementById("encryptedMessage").value="",document.getElementById("decryptedOutput").value="",document.getElementById("decryptStatus").className="status",document.getElementById("decryptStatus").textContent="",clearDecryptFile(),window.decryptedBinaryData=null})),document.getElementById("importKeyBtn").addEventListener("click",importKey),document.getElementById("exportAllKeysBtn").addEventListener("click",exportAllKeys),document.getElementById("importStateBtn").addEventListener("click",importState),document.getElementById("saveSettingsBtn").addEventListener("click",saveSettings),document.getElementById("resetSettingsBtn").addEventListener("click",resetSettings),document.getElementById("zeroKeysBtn").addEventListener("click",zeroAllKeys),encryptionKeySelect.addEventListener("change",handleEncryptionKeyChange),decryptionKeySelect.addEventListener("change",handleDecryptionKeyChange)}));let deferredPrompt,passwordModalCallback=null,passwordModalResolve=null,passwordModalReject=null;function showPasswordModal(e,t,n=!1){return new Promise(((a,r)=>{const s=document.getElementById("passwordModal"),o=document.getElementById("passwordModalTitle"),i=document.getElementById("passwordModalMessage"),c=document.getElementById("passwordModalInput"),d=document.getElementById("passwordModalStrength"),y=document.getElementById("passwordModalFeedback");o.textContent=e,i.textContent=t,c.value="",d.className="password-strength",y.textContent="",d.style.display=n?"block":"none",y.style.display=n?"block":"none",passwordModalResolve=a,passwordModalReject=r,s.style.display="flex",setTimeout((()=>{c.focus()}),100)}))}function confirmPasswordModal(){const e=document.getElementById("passwordModalInput").value,t=document.getElementById("passwordModalStrength"),n=document.getElementById("passwordModalFeedback");t.className="password-strength",n.textContent="",document.getElementById("passwordModal").style.display="none",passwordModalResolve&&(passwordModalResolve(e),passwordModalResolve=null,passwordModalReject=null)}function cancelPasswordModal(){const e=document.getElementById("passwordModalInput"),t=document.getElementById("passwordModalStrength"),n=document.getElementById("passwordModalFeedback");e.value="",t.className="password-strength",n.textContent="",document.getElementById("passwordModal").style.display="none",passwordModalReject&&(passwordModalReject(new Error("Password entry cancelled")),passwordModalResolve=null,passwordModalReject=null)}function updateModalPasswordStrength(){const e=document.getElementById("passwordModalInput").value,t=validator.measurePasswordStrength(e),n=document.getElementById("passwordModalStrength"),a=document.getElementById("passwordModalFeedback");n.className="password-strength",e?(n.classList.add(t.strengthCategory),a.textContent=t.feedback):a.textContent=""}async function copyToClipboard(e,t){const n=document.getElementById(e).value;if(!n)return void showStatus(t,"Nothing to copy","error");if(await secureClipboardCopy(n))showStatus(t,"Copied to clipboard","success"),appSettings.clearClipboard&&scheduleClipboardClear();else{showStatus(t,"Unable to copy automatically. Please select the text and press Ctrl+C (or ⌘+C) to copy manually.","warning");const n=document.getElementById(e);n.focus(),n.select()}}function toggleDarkMode(){const e=document.getElementById("darkMode").checked;e?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode"),localStorage.setItem("LemonadeDarkMode",e)}function arrayBufferToBase64(e){const t=new Uint8Array(e);let n="";for(let e=0;e<t.byteLength;e++)n+=String.fromCharCode(t[e]);return btoa(n)}function base64ToArrayBuffer(e){try{const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n.buffer}catch(e){throw console.error("Base64 decoding error:",e),new Error("Invalid base64 data: "+e.message)}}async function encryptData(e,t){if("aes"===t.type)return await encryptWithAES(e,t);if("rsa"===t.type||"rsa-4096"===t.type)return await encryptWithRSA(e,t);if("ecc"===t.type||"ecc-p384"===t.type)return await encryptWithECC(e,t);throw new Error("Unsupported key type")}async function decryptData(e,t){if(2===e.version){if("aes"===t.type)return await decryptWithAES(e,t);if("rsa"===t.type||"rsa-4096"===t.type)return await decryptWithRSA(e,t);if("ecc"===t.type||"ecc-p384"===t.type)return await decryptWithECC(e,t)}if(e.algorithm===AES_CONFIG.MODE)return await decryptWithAES(e,t);if(e.algorithm===RSA_CONFIG.ALGORITHM+"+"+AES_CONFIG.MODE||"RSA-OAEP+AES-GCM"===e.algorithm)return await decryptWithRSA(e,t);if(e.algorithm==="ECDH+"+AES_CONFIG.MODE||"ECDH+AES-GCM"===e.algorithm)return await decryptWithECC(e,t);throw new Error("Unsupported encryption algorithm: "+e.algorithm)}async function deriveKeyFromPassword(e,t){const n=(new TextEncoder).encode(e),a=await window.crypto.subtle.importKey("raw",n,{name:"PBKDF2"},!1,["deriveKey"]);return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:PBKDF2_CONFIG.ITERATIONS,hash:PBKDF2_CONFIG.HASH},a,{name:AES_CONFIG.MODE,length:AES_CONFIG.KEY_LENGTH},!0,["encrypt","decrypt"])}async function encryptWithDerivedKey(e,t,n){return window.crypto.subtle.encrypt({name:AES_CONFIG.MODE,iv:n,tagLength:AES_CONFIG.TAG_LENGTH},e,t)}async function decryptWithDerivedKey(e,t,n){return window.crypto.subtle.decrypt({name:AES_CONFIG.MODE,iv:n,tagLength:AES_CONFIG.TAG_LENGTH},e,t)}async function importAESKey(e){return window.crypto.subtle.importKey("raw",e,{name:AES_CONFIG.MODE,length:AES_CONFIG.KEY_LENGTH},!1,["encrypt","decrypt"])}async function importRSAPublicKey(e,t){return window.crypto.subtle.importKey("spki",e,{name:RSA_CONFIG.ALGORITHM,hash:RSA_CONFIG.HASH},!1,["encrypt"])}async function importRSAPrivateKey(e,t){return window.crypto.subtle.importKey("pkcs8",e,{name:RSA_CONFIG.ALGORITHM,hash:RSA_CONFIG.HASH},!1,["decrypt"])}async function importECCPublicKey(e,t){return window.crypto.subtle.importKey("spki",e,{name:"ECDH",namedCurve:t},!1,[])}async function importECCPrivateKey(e,t){return window.crypto.subtle.importKey("pkcs8",e,{name:"ECDH",namedCurve:t},!1,["deriveKey","deriveBits"])}async function saveToDatabase(e,t){return new Promise(((n,a)=>{if(!db)return void a(new Error("Database not initialized"));const r=db.transaction(e,"readwrite").objectStore(e).put(t);r.onsuccess=()=>n(),r.onerror=()=>a(r.error)}))}async function getFromDatabase(e,t){return new Promise(((n,a)=>{if(!db)return void a(new Error("Database not initialized"));const r=db.transaction(e,"readonly").objectStore(e).get(t);r.onsuccess=()=>n(r.result),r.onerror=()=>a(r.error)}))}async function getAllFromDatabase(e){return new Promise(((t,n)=>{if(!db)return void n(new Error("Database not initialized"));const a=db.transaction(e,"readonly").objectStore(e).getAll();a.onsuccess=()=>t(a.result),a.onerror=()=>n(a.error)}))}async function clearDatabase(e){return new Promise(((t,n)=>{if(!db)return void n(new Error("Database not initialized"));const a=db.transaction(e,"readwrite").objectStore(e).clear();a.onsuccess=()=>t(),a.onerror=()=>n(a.error)}))}window.exportKey=exportKey,window.exportPrivateKey=exportPrivateKey,window.deleteKey=deleteKey;const installBtn=document.getElementById("installBtn"),installContainer=document.getElementById("installContainer"),installStatus=document.getElementById("installStatus");installBtn&&(installBtn.disabled=!0),window.addEventListener("beforeinstallprompt",(e=>{if(e.preventDefault(),deferredPrompt=e,installBtn){installBtn.disabled=!1;const e=installContainer.querySelector(".install-note");e&&(e.style.display="none"),showStatus("installStatus","Installation is now available!","success")}})),installBtn&&installBtn.addEventListener("click",(async()=>{if(!deferredPrompt)return void showStatus("installStatus","Installation not available in this browser or app is already installed","warning");deferredPrompt.prompt();const{outcome:e}=await deferredPrompt.userChoice;console.log(`User response to install prompt: ${e}`),"accepted"===e?showStatus("installStatus","Lemonade has been installed successfully!","success"):showStatus("installStatus","Installation was canceled","warning"),deferredPrompt=null,installBtn.disabled=!0})),window.addEventListener("appinstalled",(()=>{console.log("Lemonade was installed"),deferredPrompt=null,installBtn&&(installBtn.disabled=!0),showStatus("installStatus","Lemonade has been installed successfully!","success")})),!("serviceWorker"in navigator)||"https:"!==window.location.protocol&&"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname?(console.log("Service Workers not supported or not in secure context"),installStatus&&("file:"===window.location.protocol?showStatus("installStatus","PWA installation requires HTTPS. You are viewing this file locally.","warning"):showStatus("installStatus","Your browser does not support PWA installation features.","warning"))):window.addEventListener("load",(function(){navigator.serviceWorker.register("sw.js").then((function(e){console.log("Service Worker registered with scope:",e.scope)})).catch((function(e){console.error("Service Worker registration failed:",e),showStatus("installStatus","Service Worker registration failed. PWA features unavailable.","warning")}))})),window.matchMedia("(display-mode: standalone)").matches&&(console.log("App is already running in standalone mode (installed)"),installStatus&&showStatus("installStatus","Lemonade is running as an installed app","success"));let encryptFileData=null,encryptFileName="",decryptFileData=null,decryptFileName="";function handleEncryptFileSelect(e){if(0===e.length)return;const t=e[0];encryptFileName=t.name;const n=new FileReader;n.onload=function(e){encryptFileData=e.target.result,document.getElementById("encryptMessage").value=`File: ${encryptFileName} (${formatFileSize(t.size)})`,document.getElementById("encryptFileInfo").style.display="flex",document.getElementById("encryptFileName").textContent=encryptFileName},n.readAsArrayBuffer(t)}function handleDecryptFileSelect(e){if(0===e.length)return;const t=e[0];decryptFileName=t.name;const n=new FileReader;n.onload=function(e){const t=e.target.result;t.includes("@!")&&t.includes("!@")?(document.getElementById("encryptedMessage").value=t,decryptFileData=null,document.getElementById("decryptFileInfo").style.display="flex",document.getElementById("decryptFileName").textContent=decryptFileName,showStatus("decryptStatus","Encrypted file loaded successfully.","success")):(showStatus("decryptStatus","This file is not in Lemonade encrypted format. Try again.","error"),document.getElementById("decryptFileInfo").style.display="none")},n.onerror=function(){showStatus("decryptStatus","Unable to read the file as a Lemonade encrypted format.","error")},n.readAsText(t)}function clearEncryptFile(){encryptFileData=null,encryptFileName="",document.getElementById("encryptMessage").value="",document.getElementById("encryptFileInfo").style.display="none",document.getElementById("encryptFileInput").value=""}function clearDecryptFile(){decryptFileData=null,decryptFileName="",document.getElementById("encryptedMessage").value="",document.getElementById("decryptFileInfo").style.display="none",document.getElementById("decryptFileInput").value=""}function formatFileSize(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}function generateRandomFileName(e=6){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let n="";for(let a=0;a<e;a++)n+=t.charAt(Math.floor(62*Math.random()));return n}document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("encryptFileInput"),t=document.getElementById("encryptBrowseBtn"),n=(document.getElementById("encryptFileInfo"),document.getElementById("encryptFileName"),document.getElementById("removeEncryptFile")),a=document.getElementById("decryptFileInput"),r=document.getElementById("decryptBrowseBtn"),s=(document.getElementById("decryptFileInfo"),document.getElementById("decryptFileName"),document.getElementById("removeDecryptFile")),o=document.getElementById("downloadEncryptedBtn"),i=document.getElementById("downloadDecryptedBtn");t.addEventListener("click",(()=>{e.click()})),e.addEventListener("change",(e=>{handleEncryptFileSelect(e.target.files)})),n.addEventListener("click",(()=>{clearEncryptFile()})),r.addEventListener("click",(()=>{a.click()})),a.addEventListener("change",(e=>{handleDecryptFileSelect(e.target.files)})),s.addEventListener("click",(()=>{clearDecryptFile()})),createKeyFileInput(),o.addEventListener("click",downloadEncryptedFile),i.addEventListener("click",downloadDecryptedFile),document.getElementById("encryptBtn").addEventListener("click",(function(){window.decryptedBinaryData=null})),document.getElementById("passwordModalConfirm").addEventListener("click",confirmPasswordModal),document.getElementById("passwordModalCancel").addEventListener("click",cancelPasswordModal),document.getElementById("passwordModalInput").addEventListener("input",updateModalPasswordStrength),document.getElementById("passwordModalInput").addEventListener("keypress",(function(e){"Enter"===e.key&&confirmPasswordModal()})),document.addEventListener("keydown",(function(e){"Escape"===e.key&&"flex"===document.getElementById("passwordModal").style.display&&cancelPasswordModal()}))}));
    </script>
<div id="passwordModal" class="modal">
    <div class="modal-content">
        <h3 id="passwordModalTitle">Enter Password</h3>
        <p id="passwordModalMessage">Please enter a password to continue:</p>
        <div class="form-group">
            <input type="password" id="passwordModalInput" placeholder="Enter password">
            <div id="passwordModalStrength" class="password-strength"></div>
            <div id="passwordModalFeedback" class="password-feedback"></div>
        </div>
        <div class="btn-group">
            <button id="passwordModalConfirm" class="btn-primary">Confirm</button>
            <button id="passwordModalCancel" class="btn-secondary">Cancel</button>
        </div>
    </div>
</div>
</body>
</html>
